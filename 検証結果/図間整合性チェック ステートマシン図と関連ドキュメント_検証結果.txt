# 検証結果：ステートマシン図・ユースケース記述・アクティビティ図の整合性チェック

---

## 1. 用語（状態名・イベント名）の整合性

### ステートマシン図の主な状態・イベント

- **状態**
    - 販売中（待機中、入金受付中、商品選択待ち、商品払い出し、釣銭_返金処理中）
    - 販売停止中（故障中、管理モード、メンテナンスモード）
- **イベント**
    - 電源ON/初期化する、電源OFF/シャットダウンする
    - お金投入、購入キャンセル、購入処理完了、釣銭・返金受取
    - メンテナンス操作、管理者操作、故障検知、メンテナンスモード終了、管理モード終了
    - メンテナンス選択、商品補充選択、釣銭補充選択、販売商品変更選択、機械状態確認選択、管理モード終了選択、メンテナンス終了選択

### ユースケース・アクティビティ図との用語対応

- **「お金投入」**
    - ステートマシン図：イベント名（お金投入）
    - ユースケースUC3「お金を投入する」：利用者の操作（BF-1）
    - アクティビティ図「お金投入を監視する」：お金投入の検知・金額認識
    - **→整合性あり**

- **「入金受付中」「商品選択待ち」**
    - ステートマシン図：状態名
    - ユースケースUC3/UC2：投入金額表示、商品選択待ちの状態（BF-2, BF-3, BF-4）
    - アクティビティ図「合計投入金額を表示する」「購入可能な商品ボタンを選択可能にする」
    - **→整合性あり**

- **「購入キャンセル」**
    - ステートマシン図：イベント名
    - ユースケースUC3/UC2：キャンセル操作（AF-1-1）、返金処理（AF-1-2）
    - アクティビティ図「投入金または釣銭を返金する」
    - **→整合性あり**

- **「商品払い出し」**
    - ステートマシン図：状態名
    - ユースケースUC2：商品払い出し（BF-5, BF-6）
    - アクティビティ図「購入商品を払いだす」
    - **→整合性あり**

- **「釣銭_返金処理中」**
    - ステートマシン図：状態名
    - ユースケースUC4「釣銭・返金を受け取る」：釣銭・返金処理（BF-2, BF-3, BF-4）
    - アクティビティ図「投入金または釣銭を返金する」
    - **→整合性あり**

- **「販売停止中」「故障中」「管理モード」「メンテナンスモード」**
    - ステートマシン図：状態名
    - ユースケースUC9「故障対応を行う」、UC10「機械の状態を確認する」、UC7「商品を補充する」、UC6「釣銭を補充する」、UC5「売上金を回収する」、UC8「販売商品を変更する」
    - アクティビティ図：該当機能は未記載だが、ユースケース記述と状態名は概ね一致
    - **→整合性あり**

- **「商品一覧を表示する」「釣銭有無を表示する」**
    - ステートマシン図：doアクティビティ
    - ユースケースUC1「商品一覧を表示する」、UC2/UC3の金額・釣銭表示
    - アクティビティ図「商品一覧を表示する」「釣銭有無を表示する」
    - **→整合性あり**

---

## 2. ユースケースの処理とステートマシン図の状態・遷移の対応

### UC3「お金を投入する」

- **BF-1～BF-4**：お金投入→金額表示→商品ボタン点灯→追加投入or商品選択orキャンセル
    - ステートマシン図「待機中」→「入金受付中」→「商品選択待ち」への遷移と一致
    - アクティビティ図「お金投入を監視する」「合計投入金額を表示する」「購入可能な商品ボタンを選択可能にする」と対応
    - **→対応関係明確**

- **AF-1（キャンセル時）**
    - ステートマシン図「入金受付中」または「商品選択待ち」→「釣銭_返金処理中」→「待機中」
    - アクティビティ図「投入金または釣銭を返金する」
    - **→対応関係明確**

### UC2「商品を選択し購入する」

- **BF-3（商品選択）**
    - ステートマシン図「商品選択待ち」→「商品払い出し」
    - アクティビティ図「商品ボタン押下を監視する」「購入商品を払いだす」
    - **→対応関係明確**

- **BF-5（商品払い出し・釣銭払い出し）**
    - ステートマシン図「商品払い出し」→（choice）→「釣銭_返金処理中」または「待機中」
    - アクティビティ図「購入商品を払いだす」「投入金または釣銭を返金する」
    - **→対応関係明確**

- **AF-1（キャンセル）**
    - 上記UC3と同様に「釣銭_返金処理中」経由で「待機中」へ
    - **→対応関係明確**

### UC4「釣銭・返金を受け取る」

- **BF-2～BF-4**
    - ステートマシン図「釣銭_返金処理中」→「待機中」（イベント：釣銭・返金受取）
    - アクティビティ図「投入金または釣銭を返金する」
    - **→対応関係明確**

### 管理・メンテナンス系ユースケース（UC5～UC10）

- ステートマシン図「販売停止中」配下の「管理モード」「メンテナンスモード」「故障中」状態
    - 各ユースケース（売上金回収、商品補充、釣銭補充、販売商品変更、機械状態確認、故障対応）と状態名・doアクティビティが一致
    - 各モード内の遷移（例：売上金回収→商品補充→釣銭補充→販売商品変更→機械状態確認→終了）は管理モードのサブステートと一致
    - **→対応関係明確**

---

## 3. アクティビティ図（機能）とステートマシン図のイベント・状態遷移の対応

- **「お金投入を監視する」**
    - ステートマシン図「販売中」doアクティビティ
    - ユースケースUC3、UC2の投入操作と一致
    - **→対応関係明確**

- **「合計投入金額を表示する」**
    - ステートマシン図「入金受付中」doアクティビティ
    - ユースケースUC3 BF-2
    - **→対応関係明確**

- **「商品ボタン押下を監視する」**
    - ステートマシン図「商品選択待ち」doアクティビティ
    - ユースケースUC2 BF-3
    - **→対応関係明確**

- **「購入商品を払いだす」**
    - ステートマシン図「商品払い出し」exitアクティビティ
    - ユースケースUC2 BF-5
    - **→対応関係明確**

- **「投入金または釣銭を返金する」**
    - ステートマシン図「釣銭_返金処理中」exitアクティビティ
    - ユースケースUC3/UC2/UC4の返金処理
    - **→対応関係明確**

- **「商品一覧を表示する」「釣銭有無を表示する」**
    - ステートマシン図「販売中」doアクティビティ
    - ユースケースUC1、UC2、UC3
    - **→対応関係明確**

---

## 4. 矛盾・対応不明確な箇所の指摘

### 4.1. **状態名・イベント名の用語揺れ・曖昧さ**

- **「釣銭_返金処理中」**
    - ユースケースやアクティビティ図では「釣銭返金」「返金処理」「釣銭・返金」など複数表現あり。
    - ステートマシン図の状態名「釣銭_返金処理中」とアクティビティ図「投入金または釣銭を返金する」は意味的には一致するが、用語統一がやや不十分。
    - **指摘**：「釣銭_返金処理中」状態名とユースケース・アクティビティ図の「返金」「釣銭」表現を統一するとより明確。

- **「商品選択待ち」**
    - ユースケースでは「商品選択」「商品ボタン押下」などの表現。
    - ステートマシン図の状態名「商品選択待ち」とアクティビティ図「商品ボタン押下を監視する」は意味的に一致。
    - **指摘**：大きな問題はないが、用語の統一を推奨。

### 4.2. **例外・エラー処理の状態遷移**

- **ユースケースの例外フロー（例：金額認識不能、商品在庫切れ、釣銭切れ等）**
    - ステートマシン図では「故障検知」イベントで「販売停止中」へ遷移するが、通常のエラー（投入金認識エラー、商品売切れ、釣銭切れ等）は「販売中」状態内で処理されている前提。
    - 例外フローが「販売停止中」への遷移を伴うのは「故障」レベルのみで、軽微なエラーは状態遷移せずにエラー表示・再選択等で吸収される設計と読み取れる。
    - **指摘**：この設計方針は妥当だが、軽微なエラー時の状態遷移やエラー表示の扱いを明記するとより明確。

### 4.3. **「釣銭・返金受取」イベントのトリガー**

- ステートマシン図では「釣銭_返金処理中」→「待機中」への遷移イベントが「釣銭・返金受取」となっているが、ユースケースやアクティビティ図では「釣銭レバー操作」や「一定時間経過」など複数のトリガーが想定されている。
- **指摘**：「釣銭・返金受取」イベントの発生条件（利用者操作 or タイムアウト等）を明記すると、ユースケースとの対応がより明確。

### 4.4. **管理・メンテナンスモードの詳細**

- ステートマシン図「管理モード」「メンテナンスモード」配下の状態・遷移は、ユースケースの業務フローと一致しているが、アクティビティ図が未提供のため、機能レベルの詳細な対応は不明。
- **指摘**：管理・メンテナンス系のアクティビティ図が追加されれば、より詳細な整合性検証が可能。

---

## 5. 総合評価

- **主な状態・イベント・遷移は、ユースケース記述・アクティビティ図と矛盾なく対応している。**
- **用語の揺れや、例外処理・エラー時の状態遷移の扱いについて、若干の記述明確化余地があるが、致命的な矛盾は認められない。**
- **管理・メンテナンス系の詳細な機能レベルのアクティビティ図が未提供のため、その部分の詳細な整合性は今後の課題。**

---

## 6. 指摘事項まとめ

1. **「釣銭_返金処理中」など返金関連の用語をユースケース・アクティビティ図と統一するとより明確。**
2. **軽微なエラー（商品売切れ、釣銭切れ等）時の状態遷移やエラー表示の扱いをステートマシン図に明記すると、例外フローとの対応が明確になる。**
3. **「釣銭・返金受取」イベントの発生条件（利用者操作、タイムアウト等）を明記すると、ユースケースとの対応が明確になる。**
4. **管理・メンテナンス系のアクティビティ図が追加されれば、より詳細な整合性検証が可能。**

---

## 7. 結論

**現状のドキュメント群において、ステートマシン図・ユースケース記述・アクティビティ図の間に重大な矛盾や対応不明瞭な箇所はありません。  
ただし、用語統一・例外処理の明記・管理系機能の詳細化など、さらなる明確化・精緻化の余地があります。**

---

**ご質問や追加の検証対象があればご指示ください。**